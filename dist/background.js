"use strict";(()=>{async function c(e,t){try{return(await chrome.storage.sync.get({[e]:t}))[e]}catch(a){return console.error(`Failed to get storage value for key ${e}:`,a),t}}async function i(e,t){try{await chrome.storage.sync.set({[e]:t})}catch(a){console.error(`Failed to set storage value for key ${e}:`,a)}}var o={SLOP_BLOCK_ENABLED:"slopBlockEnabled",DETECTION_COUNT:"detectionCount",USER_WHITELIST:"userWhitelist",BLUR_MODE:"blurMode"},r={[o.SLOP_BLOCK_ENABLED]:!1,[o.DETECTION_COUNT]:0,[o.USER_WHITELIST]:[],[o.BLUR_MODE]:!0};var u={ENABLED:{16:"icons/icon16.png",32:"icons/icon32.png",48:"icons/icon32.png",128:"icons/icon128.png"},DISABLED:{16:"icons/icon16-disabled.png",32:"icons/icon32-disabled.png",48:"icons/icon32-disabled.png",128:"icons/icon128-disabled.png"}};chrome.runtime.onInstalled.addListener(async e=>{console.log("Slop Block extension installed/updated:",e.reason),e.reason==="install"&&(await i(o.SLOP_BLOCK_ENABLED,r[o.SLOP_BLOCK_ENABLED]),await i(o.BLUR_MODE,r[o.BLUR_MODE]),await i(o.DETECTION_COUNT,r[o.DETECTION_COUNT]),await i(o.USER_WHITELIST,r[o.USER_WHITELIST]));let t=await c(o.SLOP_BLOCK_ENABLED,r[o.SLOP_BLOCK_ENABLED]);await L(t)});chrome.runtime.onMessage.addListener(async(e,t,a)=>{var n;try{switch(e.action){case"getState":let s=await c(o.SLOP_BLOCK_ENABLED,r[o.SLOP_BLOCK_ENABLED]),O=await c(o.BLUR_MODE,r[o.BLUR_MODE]);a({enabled:s,blurMode:O});break;case"stateChanged":await L(e.enabled),chrome.tabs.query({active:!0,currentWindow:!0},E=>{var d;(d=E[0])!=null&&d.id&&chrome.tabs.sendMessage(E[0].id,{action:"toggleSlop",enabled:e.enabled})}),a({success:!0});break;case"updateCount":let l=await c(o.DETECTION_COUNT,r[o.DETECTION_COUNT])+(e.count||1);await i(o.DETECTION_COUNT,l),(n=t.tab)!=null&&n.id&&await g(!0,t.tab.id,l),a({success:!0});break;default:console.warn("Unknown message action:",e.action),a({error:"Unknown action"})}}catch(s){console.error("Error handling message:",s),a({error:s instanceof Error?s.message:"Unknown error"})}return!0});async function L(e){try{let t=e?u.ENABLED:u.DISABLED;await chrome.action.setIcon({path:t});let a=e?"Slop Block: ON (click to disable)":"Slop Block: OFF (click to enable)";await chrome.action.setTitle({title:a}),console.log(`Icon updated: ${e?"enabled":"disabled"}`)}catch(t){console.error("Failed to update icon:",t)}}async function g(e,t,a){try{if(!e){await chrome.action.setBadgeText({text:"",tabId:t});return}if(a!==void 0&&a>0){let n=a>99?"99+":a.toString();await chrome.action.setBadgeText({text:n,tabId:t}),await chrome.action.setBadgeBackgroundColor({color:"#ff4444",tabId:t})}else await chrome.action.setBadgeText({text:"ON",tabId:t}),await chrome.action.setBadgeBackgroundColor({color:"#00aa00",tabId:t})}catch(n){console.error("Failed to update badge:",n)}}function T(e){return e?e.includes("twitter.com")||e.includes("x.com"):!1}chrome.tabs.onUpdated.addListener(async(e,t,a)=>{if(t.status==="complete"&&T(a.url)){let n=await c(o.SLOP_BLOCK_ENABLED,r[o.SLOP_BLOCK_ENABLED]);await g(n,e)}});console.log("Slop Block background service worker loaded");})();
