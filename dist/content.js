"use strict";(()=>{var w=(e,t)=>()=>(e&&(t=e(e=0)),t);var U=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);async function T(e,t){try{return(await chrome.storage.sync.get({[e]:t}))[e]}catch(o){return console.error(`Failed to get storage value for key ${e}:`,o),t}}async function O(e,t){try{return(await chrome.storage.local.get({[e]:t}))[e]}catch(o){return console.error(`Failed to get local storage value for key ${e}:`,o),t}}async function H(e,t){try{await chrome.storage.local.set({[e]:t})}catch(o){if(o instanceof Error&&o.message.includes("Extension context invalidated")){console.warn(`Extension context invalidated - skipping storage save for ${e}`);return}console.error(`Failed to set local storage value for key ${e}:`,o)}}var s,v,A=w(()=>{"use strict";s={SLOP_BLOCK_ENABLED:"slopBlockEnabled",DETECTION_COUNT:"detectionCount",USER_WHITELIST:"userWhitelist",BLUR_MODE:"blurMode",OPENROUTER_API_KEY:"openRouterApiKey",AI_DETECTION_ENABLED:"aiDetectionEnabled",USE_GROQ:"useGroq",SYSTEM_PROMPT:"systemPrompt",BATCH_SIZE:"batchSize",CUSTOM_PROMPT:"customPrompt",PROCESSED_TWEET_IDS:"processedTweetIds",LLM_ANALYZED_IDS:"llmAnalyzedIds"},v={[s.SLOP_BLOCK_ENABLED]:!1,[s.DETECTION_COUNT]:0,[s.USER_WHITELIST]:[],[s.BLUR_MODE]:!0,[s.OPENROUTER_API_KEY]:"",[s.AI_DETECTION_ENABLED]:!1,[s.USE_GROQ]:!0,[s.SYSTEM_PROMPT]:`You are an expert at detecting AI-generated motivational slop, engagement bait, and generic inspirational content on social media. Analyze each tweet and classify it as slop or genuine content.

SLOP INDICATORS:
\u2022 Motivational clich\xE9s: "mindset is everything", "follow your dreams", "hustle harder", "grind never stops"
\u2022 Business/money schemes: "$10k/month", "passive income", "quit my job", "financial freedom"
\u2022 Generic advice patterns: "here's what I learned", "X things nobody tells you", "stop doing this, start doing this"
\u2022 Engagement bait: "unpopular opinion", "let that sink in", "read that again", "thread \u{1F9F5}"
\u2022 AI-like structure: numbered lists, formulaic advice, excessive emojis
\u2022 Buzzwords: entrepreneur, transformation, breakthrough, optimize, unlock potential
\u2022 Sales pitches: "DM me", "link in bio", "limited time", "exclusive access"

Return JSON format: {"results": [{"id": 0, "isSlop": true/false, "confidence": 0.0-1.0}]} where id matches tweet position (0-14).`,[s.BATCH_SIZE]:10,[s.CUSTOM_PROMPT]:"",[s.PROCESSED_TWEET_IDS]:[],[s.LLM_ANALYZED_IDS]:[]}});function m(...e){F&&console.log("[SlopBlock DOM]",...e)}function R(){return Array.from(document.querySelectorAll('[data-testid="tweet"]')).filter(e=>{let t=e.closest("article");return t&&!t.hasAttribute("data-slop-processed")})}function $(e){let t=e.querySelectorAll('a[href*="/status/"]');for(let o of Array.from(t)){let n=o.href.match(/\/status\/(\d+)/);if(n&&n[1])return n[1]}return null}function z(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o),t|=0;return"h"+Math.abs(t)}function N(e){var t,o,r,n;try{let l=$(e),a=W(e);if(!a)return m("No text extracted for tweet:",e),null;q.textExtracted++;let p=e.querySelector('[data-testid="User-Name"]'),c=((t=p==null?void 0:p.textContent)==null?void 0:t.trim())||"unknown",g={replies:e.querySelector('[data-testid="reply"]'),retweets:e.querySelector('[data-testid="retweet"]'),likes:e.querySelector('[data-testid="like"]')},d={replies:L(((o=g.replies)==null?void 0:o.textContent)||"0"),retweets:L(((r=g.retweets)==null?void 0:r.textContent)||"0"),likes:L(((n=g.likes)==null?void 0:n.textContent)||"0")},i={id:l||z(a),text:a,username:c,engagement:d,element:e,timestamp:Date.now()};return m("Extracted tweet data:",{username:c,textLength:a.length,engagement:d,textPreview:a.substring(0,100)+"..."}),i}catch(l){return console.error("Error extracting tweet data:",l),null}}function W(e){var g,d;let t="",r=e.querySelector('[data-testid="tweetText"]');if((g=r==null?void 0:r.textContent)!=null&&g.trim())return t=r.textContent.trim(),m("Strategy 1 success:",t.substring(0,50)),t;let n=["[lang] span",".css-901oao span",'[dir="auto"] span'];for(let i of n){let u=e.querySelectorAll(i),h=Array.from(u).map(f=>{var E;return(E=f.textContent)==null?void 0:E.trim()}).filter(f=>f&&f.length>0);if(h.length>0&&(t=h.join(" ").trim(),t.length>10))return m("Strategy 2 success:",t.substring(0,50)),t}let l=e.querySelectorAll('[lang]:not([lang=""])');for(let i of Array.from(l)){let u=(d=i.textContent)==null?void 0:d.trim();u&&u.length>t.length&&(t=u)}if(t.trim().length>10)return m("Strategy 3 success:",t.substring(0,50)),t.trim();let a=e.querySelector('[data-testid="tweet"]')||e,c=Y(a).map(i=>{var u;return(u=i.textContent)==null?void 0:u.trim()}).filter(i=>i&&i.length>3).filter(i=>!G(i));return c.length>0?(t=c.join(" ").trim(),m("Strategy 4 success:",t.substring(0,50)),t):(m("All strategies failed for element:",e),"")}function Y(e){let t=[],o=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:n=>{var c;let l=n.parentElement;if(!l)return NodeFilter.FILTER_REJECT;let a=l.tagName.toLowerCase();if(["script","style","svg"].includes(a))return NodeFilter.FILTER_REJECT;let p=(c=n.textContent)==null?void 0:c.trim();return!p||p.length<3?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),r;for(;r=o.nextNode();)t.push(r);return t}function G(e){return[/^\d+[hms]$/,/^Â·$/,/^@/,/^Show this thread$/,/^Replying to/,/^Quote Tweet$/,/^Retweet$/,/^\d+$/,/^Show replies$/,/^More$/].some(o=>o.test(e.trim()))}function L(e){if(!e)return 0;let t=e.replace(/[^\d.KMkm]/g,""),o=parseFloat(t);return isNaN(o)?0:t.toLowerCase().includes("k")?Math.round(o*1e3):t.toLowerCase().includes("m")?Math.round(o*1e6):Math.round(o)}function C(e){if(e.hasAttribute("data-ai-collapsed"))return;e.querySelectorAll(".ai-tweet-bar").forEach(n=>n.remove());let o=e.innerHTML;e.setAttribute("data-ai-original-content",o);let r=document.createElement("div");r.className="ai-tweet-bar",r.style.cssText=`
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 8px 12px;
    margin: 4px 0;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 20px;
  `,r.innerHTML=`
    <span style="color: #657786; font-size: 13px; font-weight: 400;">ai tweet hidden</span>
    <span style="color: #657786; font-size: 12px;">\u25BC</span>
  `,r.addEventListener("mouseenter",()=>{r.style.backgroundColor="#f7f9fa"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor="white"}),r.addEventListener("click",n=>{n.stopPropagation(),K(e)}),e.innerHTML="",e.appendChild(r),e.setAttribute("data-ai-collapsed","true"),e.style.display="block"}function K(e){if(!e.hasAttribute("data-ai-collapsed"))return;let t=e.getAttribute("data-ai-original-content");t&&(e.innerHTML=t),e.querySelectorAll(".ai-hide-header").forEach(n=>n.remove());let r=document.createElement("div");r.className="ai-hide-header",r.style.cssText=`
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 6px 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    justify-content: space-between;
  `,r.innerHTML=`
    <span style="color: #657786; font-size: 13px; font-weight: 400;">\u{1F916} hide ai tweet</span>
    <span style="color: #657786; font-size: 12px;">\u25B2</span>
  `,r.addEventListener("mouseenter",()=>{r.style.backgroundColor="#f7f9fa"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor="white"}),r.addEventListener("click",n=>{n.stopPropagation(),C(e)}),e.insertBefore(r,e.firstChild),e.removeAttribute("data-ai-collapsed"),e.removeAttribute("data-ai-original-content")}var F,q,_=w(()=>{"use strict";F=window.DEBUG_SLOP_DETECTION||!1;q={totalTweets:0,textExtracted:0,slopDetected:0}});async function k(e,t=!0){var p,c,g;if(e.length===0)return[];let o=await T(s.OPENROUTER_API_KEY,v[s.OPENROUTER_API_KEY]);if(!o)return console.warn("[OpenRouter] No API key set \u2013 skipping remote analysis"),null;let r=await T(s.SYSTEM_PROMPT,v[s.SYSTEM_PROMPT]),n=`Analyze these ${e.length} tweets and identify which are AI-generated motivational slop, engagement bait, or generic inspirational content. Return JSON with format: {"results": [{"id": 0, "isSlop": true/false, "confidence": 0.0-1.0}]}

Tweets:
${e.map((d,i)=>`${i}: ${d}`).join(`

`)}`,a={model:"meta-llama/llama-4-maverick",temperature:.1,max_tokens:1e3,messages:[{role:"system",content:r},{role:"user",content:n}],response_format:{type:"json_object"}};t&&(a.provider={order:["groq"]});try{console.log("[OpenRouter] Sending request with",e.length,"tweets");let d=await fetch(j,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"SlopBlock Extension"},body:JSON.stringify(a)});if(!d.ok){let E=await d.text();return console.error("[OpenRouter] HTTP error",d.status,E),null}let i=await d.text();if(console.log("[OpenRouter] Full response text:",i),!i.trim())return console.error("[OpenRouter] Empty response from API"),null;let u;try{u=JSON.parse(i)}catch(E){return console.error("[OpenRouter] Failed to parse response JSON:",E),console.error("[OpenRouter] Response was:",i),null}let h=(g=(c=(p=u==null?void 0:u.choices)==null?void 0:p[0])==null?void 0:c.message)==null?void 0:g.content;if(!h)return console.error("[OpenRouter] No content in response data:",u),null;console.log("[OpenRouter] AI response content:",h);let f;try{f=JSON.parse(h)}catch(E){return console.error("[OpenRouter] Failed to parse AI response JSON:",E),console.error("[OpenRouter] AI content was:",h),null}return console.log("[OpenRouter] Parsed results:",f),f.results||f}catch(d){return console.error("[OpenRouter] Network/parse error",d),null}}var j,P=w(()=>{"use strict";A();j="https://openrouter.ai/api/v1/chat/completions"});var ae=U(()=>{A();_();P();console.log("\u{1F50D} SlopBlock: Script loaded at",new Date().toISOString());console.log("\u{1F50D} SlopBlock: URL:",window.location.href);console.log("\u{1F50D} SlopBlock: Document ready state:",document.readyState);var J=200,V=10,I=15,b=[],S=[],D=new Map,y=!1,x=null;async function Q(){b=await O(s.PROCESSED_TWEET_IDS,[])}async function Z(){await H(s.PROCESSED_TWEET_IDS,b)}function X(e){var t;b.push(e),b.length>J&&b.splice(0,V),(t=chrome==null?void 0:chrome.runtime)!=null&&t.id&&Z()}async function ee(e){let t=e.map(o=>o.text);console.log("[Batch] Analyzing",e.length,"tweets with OpenRouter..."),console.log("[Batch] Tweet texts being sent:",t);try{let o=await T(s.USE_GROQ,!0);console.log("[Batch] Using Groq:",o);let r=await k(t,o);if(console.log("[Batch] OpenRouter returned:",r),!r)return console.log("[Batch] No API key or analysis failed"),new Set;let n=new Set;return r.forEach((l,a)=>{var p,c;if(console.log("[Batch] Processing result",a,":",l),l.isSlop&&a<e.length){let g=e[a].id;n.add(g),console.log("[Flagged]",g,"confidence:",l.confidence,"text:",e[a].text.substring(0,100))}else console.log("[Clean]",(p=e[a])==null?void 0:p.id,"text:",(c=e[a])==null?void 0:c.text.substring(0,100))}),console.log("[Batch] Final result: Flagged",n.size,"out of",e.length,"tweets"),console.log("[Batch] Flagged IDs:",Array.from(n)),n}catch(o){return console.error("[Batch] Analysis error:",o),new Set}}function te(e){e.forEach(t=>{let o=D.get(t);o&&(C(o),console.log("[Collapsed AI Tweet]",t))})}async function oe(){if(S.length<I)return;let e=S.splice(0,I),t=await ee(e);te(t)}function M(e){if(!y)return;let t=N(e);if(!t)return;let{id:o,text:r}=t;!o||b.includes(o)||(console.log("[Tweet]",o,r.substring(0,120)),X(o),S.push({id:o,text:r,element:e}),D.set(o,e),oe())}function re(){y&&R().forEach(e=>M(e))}function ne(){x||(x=new MutationObserver(e=>{y&&e.forEach(t=>{t.addedNodes.forEach(o=>{var r;if(o.nodeType===Node.ELEMENT_NODE){let n=o;n.matches('[data-testid="tweet"]')?M(n):(r=n.querySelectorAll)==null||r.call(n,'[data-testid="tweet"]').forEach(l=>M(l))}})})}),x.observe(document.body,{childList:!0,subtree:!0}))}function se(){x&&(x.disconnect(),x=null)}async function B(){let e=await T(s.SLOP_BLOCK_ENABLED,!1);console.log("[Extension] State changed to:",e?"ENABLED":"DISABLED"),e&&!y?(y=!0,ne(),re()):!e&&y&&(y=!1,se(),S.length=0)}chrome.runtime.onMessage.addListener(e=>{e.action==="stateChanged"&&B()});(async()=>(await Q(),await B()))()});ae();})();
