"use strict";(()=>{function h(e){let t=[];return e.querySelectorAll('[data-testid="tweet"]').forEach(r=>{let s=I(r);s&&t.push(s)}),t}function I(e){var t,o;try{let r=e.querySelector('[data-testid="tweetText"]'),s=((t=r==null?void 0:r.textContent)==null?void 0:t.trim())||"",c=p(e,"like"),f=p(e,"retweet"),k=p(e,"reply"),A=!!e.querySelector('[data-testid="icon-verified"]'),m=e.querySelector('[data-testid="User-Name"] a'),_=((o=m==null?void 0:m.textContent)==null?void 0:o.replace("@",""))||"";return{element:e,textContent:s,metadata:{likes:c,retweets:f,replies:k,isVerified:A,username:_}}}catch(r){return console.warn("Failed to extract tweet data:",r),null}}function p(e,t){var o;try{let r="";switch(t){case"like":r='[data-testid="like"]';break;case"retweet":r='[data-testid="retweet"]';break;case"reply":r='[data-testid="reply"]';break}let s=e.querySelector(r),c=s==null?void 0:s.querySelector('[data-testid$="count"]'),f=((o=c==null?void 0:c.textContent)==null?void 0:o.trim())||"0";return D(f)}catch{return 0}}function D(e){if(!e||e==="0")return 0;let t=e.toLowerCase(),o=parseFloat(t);return t.includes("k")?Math.floor(o*1e3):t.includes("m")?Math.floor(o*1e6):Math.floor(o)||0}function b(e,t){e.classList.remove("slop-blurred","slop-hidden"),t==="blur"?e.classList.add("slop-blurred"):t==="hide"&&e.classList.add("slop-hidden")}function g(e){e.classList.remove("slop-blurred","slop-hidden")}function w(e,t){let o;return function(...r){o||(e.apply(this,r),o=!0,setTimeout(()=>o=!1,t))}}async function S(e,t){try{return(await chrome.storage.sync.get({[e]:t}))[e]}catch(o){return console.error(`Failed to get storage value for key ${e}:`,o),t}}var i={SLOP_BLOCK_ENABLED:"slopBlockEnabled",DETECTION_COUNT:"detectionCount",USER_WHITELIST:"userWhitelist",BLUR_MODE:"blurMode"},v={[i.SLOP_BLOCK_ENABLED]:!1,[i.DETECTION_COUNT]:0,[i.USER_WHITELIST]:[],[i.BLUR_MODE]:!0};function y(e,t){return N(e,t).isSlop}function N(e,t){let o=[],r=0;return e.toLowerCase().includes("ai generated")&&(o.push('Contains "AI generated" phrase'),r+=.8),e.toLowerCase().includes("as an ai")&&(o.push("Contains AI self-identification"),r+=.9),t.likes+t.retweets+t.replies===0&&e.length>200&&(o.push("Long tweet with no engagement"),r+=.3),r=Math.min(r,1),{isSlop:r>.5,confidence:r,reasons:o}}function L(e,t){if(!e||!t.length)return!1;let o=e.toLowerCase().replace("@","");return t.some(r=>r.toLowerCase()===o)}var n=!1,u=!0,T=[],l=new Set;async function M(){console.log("Slop Block content script initializing...");try{let e=await chrome.runtime.sendMessage({action:"getState"});e&&(n=e.enabled,u=e.blurMode),T=await S(i.USER_WHITELIST,v[i.USER_WHITELIST]),console.log(`Slop Block initialized: enabled=${n}, blurMode=${u}`),n&&x(),d()}catch(e){console.error("Failed to initialize Slop Block:",e)}}function x(){a&&a.disconnect(),a=new MutationObserver(w(e=>{n&&e.forEach(t=>{t.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&O(o)})})},100)),a.observe(document.body,{childList:!0,subtree:!0}),console.log("DOM observer started")}function U(){a&&(a.disconnect(),a=null),console.log("DOM observer stopped")}function d(){n&&(console.log("Processing existing tweets..."),O(document.body))}function O(e){h(e).forEach(o=>R(o))}function R(e){if(!l.has(e.element))try{if(e.metadata.username&&L(e.metadata.username,T)){l.add(e.element);return}if(y(e.textContent,e.metadata)){console.log("Slop detected:",{text:e.textContent.substring(0,100)+"...",username:e.metadata.username,engagement:{likes:e.metadata.likes,retweets:e.metadata.retweets,replies:e.metadata.replies}});let o=u?"blur":"hide";b(e.element,o),chrome.runtime.sendMessage({action:"updateCount",count:1})}else g(e.element);l.add(e.element)}catch(t){console.error("Error processing tweet:",t)}}function E(){l.forEach(e=>{g(e)}),l.clear(),console.log("All tweet effects cleared")}chrome.runtime.onMessage.addListener((e,t,o)=>{switch(console.log("Content script received message:",e),e.action){case"toggleSlop":n=e.enabled,console.log(`Slop Block ${n?"enabled":"disabled"}`),n?(x(),d()):(U(),E());break;case"updateSettings":e.blurMode!==void 0&&(u=e.blurMode,n&&(E(),d())),e.whitelist!==void 0&&(T=e.whitelist,n&&(E(),d()));break;default:console.warn("Unknown message action:",e.action)}o({success:!0})});var a=null;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M();var C=location.href;new MutationObserver(()=>{location.href!==C&&(C=location.href,console.log("Page navigation detected, reinitializing..."),l.clear(),setTimeout(()=>{n&&d()},1e3))}).observe(document,{subtree:!0,childList:!0});console.log("Slop Block content script loaded");})();
